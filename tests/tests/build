#!/usr/bin/env bash

set -x # Show commands
set -eu # Errors/undefined vars are fatal
set -o pipefail # Check all commands in a pipeline

mkdir -p $OBJDIR

echo "Performing build::indexer-setup step for $TREE_NAME : $(date +"%Y-%m-%dT%H:%M:%S%z")"

# Add the special clang flags.
$MOZSEARCH_PATH/scripts/indexer-setup.py > $INDEX_ROOT/config
source $INDEX_ROOT/config

cd $INDEX_ROOT/files

## Rust build via cargo
# This must happen before other build steps or the `cargo clean` will delete all
# the other build outputs!
echo "Performing build::cargo-build step for $TREE_NAME : $(date +"%Y-%m-%dT%H:%M:%S%z")"

export CARGO_TARGET_DIR=$OBJDIR
cargo clean
RUSTFLAGS="-A mixed_script_confusables" cargo build

echo "Performing build::rust-analyzer step for $TREE_NAME : $(date +"%Y-%m-%dT%H:%M:%S%z")"

# TODO: Uncomment once https://github.com/rust-lang/rust-analyzer/pull/15633 is
# merged.
#
# cat <<EOF >$OBJDIR/rust-analyzer.json
# {
#   "rust-analyzer.server.extraEnv": {
#     "CARGO_TARGET_DIR": "$OBJDIR"
#   }
# }
# EOF
#
# rust-analyzer scip . --output $OBJDIR/rust.scip --config-path $OBJDIR/rust-analyzer.json

rust-analyzer scip . --output $OBJDIR/rust.scip

# Remove artifacts in the wrong target directory created by rust-analyzer.
# TODO: Remove once we can give it a target dir as per the above.
rm -rf target/

## XPIDL Stuff
echo "Performing build::xpidl step for $TREE_NAME : $(date +"%Y-%m-%dT%H:%M:%S%z")"

XPIDL_SAVED_GENERATED_FILES=../mc-generated
XPIDL_SAVED_ANALYSIS_FILES=../mc-analysis
rsync -av $XPIDL_SAVED_GENERATED_FILES/ $OBJDIR
mkdir -p $INDEX_ROOT/analysis/
rsync -av $XPIDL_SAVED_ANALYSIS_FILES/ $INDEX_ROOT/analysis/

echo "Performing build::scip-java step for $TREE_NAME : $(date +"%Y-%m-%dT%H:%M:%S%z")"

# Use Gradle from PATH if available
if command -v gradle &> /dev/null; then
  GRADLE=gradle
else
  GRADLE=./gradlew
fi

## Java stuff
echo "Performing build::scip-indexer-gradle step for $TREE_NAME : $(date +"%Y-%m-%dT%H:%M:%S%z")"

"$GRADLE" --no-daemon clean build
scip-java index-semanticdb build/semanticdb-targetroot --no-emit-inverse-relationships --output=$OBJDIR/gradle.scip
"$GRADLE" --no-daemon clean
rm -rf build/

scip-indexer \
  "$CONFIG_FILE" \
  "$TREE_NAME" \
  --subtree-root "." \
  "$OBJDIR/gradle.scip"

echo "Performing build::scip-indexer-rust step for $TREE_NAME : $(date +"%Y-%m-%dT%H:%M:%S%z")"

scip-indexer \
  "$CONFIG_FILE" \
  "$TREE_NAME" \
  --subtree-root "." \
  "$OBJDIR/rust.scip"

PLATFORMS="linux64 linux64-opt macosx64-aarch64 macosx64-aarch64-opt win64 win64-opt"

for PLATFORM in ${PLATFORMS}
do
  mkdir -p $INDEX_ROOT/analysis-$PLATFORM/
done

## C++ Build Stuff
echo "Performing build::build-c step for $TREE_NAME : $(date +"%Y-%m-%dT%H:%M:%S%z")"

find . -name '*.cpp' | \
    grep -v /ipdl/ > $INDEX_ROOT/c-input-files
find $OBJDIR -name '*.cpp' | \
    grep -v /ipdl/ >> $INDEX_ROOT/c-input-files

cat $INDEX_ROOT/c-input-files | \
    parallel --halt 2 -q \
    $MOZSEARCH_PATH/tests/tests/build-c.sh {} $OBJDIR "$PLATFORMS"

## moz.build generated files
echo "Performing build::cp-generated step for $TREE_NAME : $(date +"%Y-%m-%dT%H:%M:%S%z")"

for PLATFORM in ${PLATFORMS}; do
    mkdir -p ${OBJDIR}/__${PLATFORM}__
    mkdir -p ${OBJDIR}/__${PLATFORM}__/mozbuild
    cp ${INDEX_ROOT}/files/mozbuild/__generated-header.h ${OBJDIR}/__${PLATFORM}__/mozbuild/generated-header.h
    cp ${INDEX_ROOT}/files/mozbuild/__generated-header2.h ${OBJDIR}/__${PLATFORM}__/mozbuild/generated-header2.h
done

## Python Stuff
echo "Performing build::cp-generated step for $TREE_NAME : $(date +"%Y-%m-%dT%H:%M:%S%z")"

scip-python index --show-progress-rate-limit 0 --project-name python --project-version 0.0.0 --environment ../python-scip-env.json --output python.scip
mv python.scip $INDEX_ROOT

echo "Performing build::scip-indexer-python step for $TREE_NAME : $(date +"%Y-%m-%dT%H:%M:%S%z")"

scip-indexer \
  "$CONFIG_FILE" \
  "$TREE_NAME" \
  --subtree-root "." \
  "$INDEX_ROOT/python.scip"

## Re-map files dynamically generated by build.rs to a consistent path.
#
# This is a cut-down version of what we do in mozsearch-mozilla's
# process-tc-artifacts.sh script.  Please consult its documentation, as all
# comments have been removed from this file in the interest of not having the
# comments diverge:
# https://github.com/mozsearch/mozsearch-mozilla/blob/master/shared/process-tc-artifacts.sh
echo "Performing build::remap-path step for $TREE_NAME : $(date +"%Y-%m-%dT%H:%M:%S%z")"

function move_file {
    mkdir -p "$(dirname $2)"
    mv "$1" "$2"
}

# Enter objdir to normalize the rust build script paths.
pushd $OBJDIR

# Difference: We have no RUST_PLATFORM dir at the root, just "debug".
PATH_TRANSFORM="s#^((debug|release)/build/([^/]+)-[0-9a-f]+/out/(.+))\$#\1 __RUST_BUILD_SCRIPT__/\3/\4#p"
find "debug" -type f  | sed -nEe "$PATH_TRANSFORM" | while read -r source target; do
  move_file "$source" "$target"
done

# Leave the objdir now that we're done normalizing build-dir paths.
popd

echo "Performing build::c++-generated step for $TREE_NAME : $(date +"%Y-%m-%dT%H:%M:%S%z")"

# Firefox generates files named something like Configure.cpp during
# the build process, but their source files are not around by the time
# we run the analysis. crossref.rs needs to be able to deal with this
# case by ignoring the error and continuing with the other files,
# rather than bailing out. This simulates that case.
#
# This will intentionally result in the following crossref output:
# `Unable to open source file /home/vagrant/index/tests/files/BuildTimeFile.cpp`
BUILD_TIME_FILE=BuildTimeFile.cpp
echo "int main() { return 0; }" > $BUILD_TIME_FILE
$CXX -DTEST_MACRO1 -DTEST_MACRO2 $BUILD_TIME_FILE -std=c++17 -c -o $OBJDIR/BuildTimeFile.o -Wall
rm BuildTimeFile.cpp

GENERATED_FILE=$OBJDIR/GeneratedFile.cpp
cat <<EOF > $GENERATED_FILE
namespace generated {
struct GeneratedStruct {
  int x;
  int y;
};
}
int main() {
  generated::GeneratedStruct s;
  s.x = 10;
  return s.x;
}
EOF
$CXX -DTEST_MACRO1 -DTEST_MACRO2 $GENERATED_FILE -std=c++17 -c -o $OBJDIR/GeneratedFile.o -Wall
